{% extends 'base.html.twig' %}

{% block title %}Quiz Results{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}

{% block body %}
    <div class="result-container">
        <h1>Quiz Results</h1>

        <div class="result-card">
            <div class="score">{{ score|number_format }}%</div>

            <div class="score-details">
                You answered {{ correctAnswers }} out of {{ totalQuestions }} questions correctly.
            </div>

            <div class="feedback">
                {% if score >= 90 %}
                    <p>Excellent! You have a great understanding of Symfony 7.0!</p>
                {% elseif score >= 70 %}
                    <p>Good job! You have a solid understanding of Symfony 7.0.</p>
                {% elseif score >= 50 %}
                    <p>Not bad! Keep learning to improve your Symfony 7.0 knowledge.</p>
                {% else %}
                    <p>Keep studying! Symfony 7.0 has a lot to offer.</p>
                {% endif %}
            </div>

            {% if questionsWithAnswers is defined and questionsWithAnswers|length > 0 %}
                <div class="questions-review">
                    <h3>Review Your Answers</h3>
                    {% for question in questionsWithAnswers %}
                        <div class="question-review">
                            <div class="question-text">{{ question.text|nl2br }}</div>
                            <div class="answers-list">
                                {% for answer in question.answers %}
                                    <div class="answer-item {% if answer.id in question.selectedAnswers %}selected{% endif %} {% if answer.isCorrect %}correct{% endif %}">
                                        <span class="answer-marker">
                                            {% if answer.id in question.selectedAnswers and answer.isCorrect %}
                                                <span class="correct-mark">✓</span>
                                            {% elseif answer.id in question.selectedAnswers and not answer.isCorrect %}
                                                <span class="incorrect-mark">✗</span>
                                            {% elseif not (answer.id in question.selectedAnswers) and answer.isCorrect %}
                                                <span class="missed-mark">•</span>
                                            {% endif %}
                                        </span>
                                        <span class="answer-text">{{ answer.text }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="success-rates" style="margin: 20px 0; padding: 15px; background-color: #f0f8ff; border-radius: 5px; text-align: left;">
                <h3 style="margin-bottom: 10px;">Success Rates</h3>

                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    {% if categoryStats %}
                        <div style="flex: 1; min-width: 200px;">
                            <h4>{{ categoryStats.name }} Category</h4>
                            <p><strong>Quizzes Taken:</strong> {{ categoryStats.totalQuizzes }}</p>
                            <p><strong>Average Success Rate:</strong> {{ categoryStats.successRate|number_format }}%</p>
                            <p><strong>Your Score:</strong> {{ score|number_format }}%</p>
                            <p><strong>Comparison:</strong>
                                {% if score > categoryStats.successRate %}
                                    <span style="color: green;">{{ (score - categoryStats.successRate)|number_format }}% above average</span>
                                {% elseif score < categoryStats.successRate %}
                                    <span style="color: #e74c3c;">{{ (categoryStats.successRate - score)|number_format }}% below average</span>
                                {% else %}
                                    <span>Equal to average</span>
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}

                    <div style="flex: 1; min-width: 200px;">
                        <h4>Overall</h4>
                        <p><strong>Average Success Rate:</strong> {{ overallSuccessRate|number_format }}%</p>
                        <p><strong>Your Score:</strong> {{ score|number_format }}%</p>
                        <p><strong>Comparison:</strong>
                            {% if score > overallSuccessRate %}
                                <span style="color: green;">{{ (score - overallSuccessRate)|number_format }}% above average</span>
                            {% elseif score < overallSuccessRate %}
                                <span style="color: #e74c3c;">{{ (overallSuccessRate - score)|number_format }}% below average</span>
                            {% else %}
                                <span>Equal to average</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            {% if chart is defined %}
                <div data-controller="chart-toggle">
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
                        <div>
                            <label for="category-filter">Filter by Category: </label>
                            <select id="category-filter" data-chart-toggle-target="categorySelect">
                                <option value="all">All Categories</option>
                                {% if categoryStats %}
                                    <option value="{{ quizResult.category.id }}" selected>{{ categoryStats.name }}</option>
                                {% endif %}
                                {% for category in categories|default([]) %}
                                    {% if not categoryStats or category.id != quizResult.category.id %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="chart-container" data-chart-toggle-target="chart">
                        <h3>Your Performance Trend</h3>
                        {{ render_chart(chart, {'id': 'performance-chart'}) }}
                    </div>
                </div>
            {% endif %}

            <div style="margin-top: 20px;">
                <a href="{{ path('quiz_index') }}" class="btn-primary">Back to Home</a>
                <a href="{{ path('quiz_all') }}" class="btn-success">Try Another Quiz</a>
            </div>
        </div>
    </div>
{% endblock %}
